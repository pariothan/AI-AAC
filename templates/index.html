<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI-AAC</title>
    <script>
        window.APP_CONFIG = {
            basePath: {{ base_path|tojson }}
        };
    </script>
    <style>
        :root {
            --primary: #5465ff;
            --primary-hover: #3f53ec;
            --surface: rgba(255, 255, 255, 0.98);
            --surface-muted: #f2f4ff;
            --surface-strong: #ffffff;
            --border: rgba(84, 101, 255, 0.18);
            --border-strong: rgba(84, 101, 255, 0.32);
            --text-strong: #0f172a;
            --text-muted: #636f88;
            --shadow-lg: 0 28px 60px rgba(15, 23, 42, 0.08);
            --shadow-sm: 0 12px 30px rgba(84, 101, 255, 0.12);
            --radius-lg: 28px;
            --radius-md: 20px;
            --radius-sm: 12px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, Arial, sans-serif;
            background: linear-gradient(180deg, #e8efff 0%, #f9fbff 100%);
            color: var(--text-strong);
            height: 100vh;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: stretch;
            padding: 16px;
            overflow: hidden;
        }

        h1, h2, h3 {
            font-weight: 700;
        }

        button {
            font: inherit;
        }

        .app-shell {
            max-width: 1280px;
            width: 100%;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .container {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 18px;
            display: flex;
            gap: 20px;
            align-items: stretch;
            min-height: 0;
            height: 100%;
            box-shadow: var(--shadow-lg);
        }

        /* Sidebar - Word Bank */
        .sidebar {
            flex: 0 0 320px;
            background: var(--surface-muted);
            display: flex;
            flex-direction: column;
            gap: 14px;
            border-radius: var(--radius-md);
            padding: 18px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow-sm);
            transition: flex-basis 0.3s ease;
            height: 100%;
            min-height: 0;
            overflow: hidden;
        }

        .sidebar.focused {
            flex-basis: min(520px, 55%);
        }

        .sidebar-header {
            display: flex;
            flex-direction: column;
            gap: 18px;
            flex-shrink: 0;
        }

        .logo {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-strong);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .focus-btn {
            width: 40px;
            height: 40px;
            background: var(--surface-strong);
            border: 1px solid var(--border-strong);
            border-radius: 12px;
            cursor: pointer;
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
            box-shadow: var(--shadow-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
        }

        .focus-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 14px 25px rgba(84, 101, 255, 0.22);
        }

        .focus-btn.active {
            background: var(--primary);
            color: white;
            border-color: transparent;
        }

        .input-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .search-box {
            padding-top: 10px;
            border-top: 1px dashed rgba(84, 101, 255, 0.16);
            flex-shrink: 0;
        }

        .search-box input[type="text"] {
            margin-top: 10px;
        }

        input[type="text"] {
            width: 100%;
            padding: 12px 16px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            background: var(--surface-strong);
            font-size: 15px;
            outline: none;
            transition: border 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
            color: var(--text-strong);
        }

        input[type="text"]::placeholder {
            color: #9ba5c0;
        }

        input[type="text"]:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(84, 101, 255, 0.18);
            background: #ffffff;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 12px 18px;
            border-radius: var(--radius-sm);
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            border: 1px solid transparent;
            transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-primary {
            background: var(--primary);
            color: #ffffff;
            box-shadow: var(--shadow-sm);
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--primary-hover);
            transform: translateY(-2px);
            box-shadow: 0 18px 32px rgba(84, 101, 255, 0.28);
        }

        .word-bank {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding-right: 4px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            min-height: 0;
        }

        .word-bank::-webkit-scrollbar,
        .sentences-list::-webkit-scrollbar {
            width: 10px;
        }

        .word-bank::-webkit-scrollbar-thumb,
        .sentences-list::-webkit-scrollbar-thumb {
            background: rgba(84, 101, 255, 0.2);
            border-radius: 20px;
        }

        .word-bank::-webkit-scrollbar-track,
        .sentences-list::-webkit-scrollbar-track {
            background: transparent;
        }

        .category {
            background: var(--surface-strong);
            border-radius: var(--radius-sm);
            border: 1px solid transparent;
            transition: border 0.2s ease, box-shadow 0.2s ease;
        }

        .category:hover {
            border-color: var(--border);
            box-shadow: 0 16px 30px rgba(84, 101, 255, 0.12);
        }

        .category-header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            color: var(--text-strong);
            border-radius: var(--radius-sm);
            cursor: pointer;
            user-select: none;
            font-size: 15px;
            font-weight: 600;
            transition: background 0.2s ease, color 0.2s ease;
        }

        .category-header:hover {
            background: rgba(84, 101, 255, 0.08);
        }

        .category-header.expanded {
            background: rgba(84, 101, 255, 0.12);
            color: var(--primary);
        }

        .category-icon {
            font-size: 18px;
            flex-shrink: 0;
            width: 24px;
            text-align: center;
        }

        .category-name {
            flex: 1;
        }

        .category-arrow {
            transition: transform 0.2s ease;
            font-size: 11px;
            color: var(--text-muted);
            flex-shrink: 0;
        }

        .category-arrow.expanded {
            transform: rotate(90deg);
        }

        .category-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.35s ease;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            padding: 0 10px;
        }

        .category-content.expanded {
            max-height: 3000px;
            padding: 10px;
        }

        .bank-term {
            background: var(--surface-muted);
            padding: 9px 12px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            border: 1px solid transparent;
            user-select: none;
            font-size: 15px;
            font-weight: 500;
            transition: transform 0.2s ease, box-shadow 0.2s ease, border 0.2s ease, background 0.2s ease;
            white-space: nowrap;
            box-shadow: 0 8px 18px rgba(84, 101, 255, 0.12);
        }

        .bank-term:hover {
            background: rgba(84, 101, 255, 0.15);
            border-color: rgba(84, 101, 255, 0.35);
            transform: translateY(-2px);
            box-shadow: 0 16px 30px rgba(84, 101, 255, 0.18);
        }

        .bank-term:active {
            cursor: grabbing;
            transform: scale(0.98);
        }

        .term-count {
            margin-top: auto;
            padding-top: 16px;
            border-top: 1px dashed rgba(84, 101, 255, 0.2);
            font-size: 13px;
            color: var(--text-muted);
            text-align: center;
            flex-shrink: 0;
        }

        /* Main Canvas Area */
        .canvas-area {
            flex: 1;
            display: flex;
            gap: 18px;
            align-items: stretch;
            min-height: 0;
        }

        .workspace-column {
            flex: 1;
            background: var(--surface-muted);
            border-radius: var(--radius-md);
            padding: 18px 18px 22px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow-sm);
            display: flex;
            flex-direction: column;
            gap: 18px;
            position: relative;
            min-height: 0;
            overflow: hidden;
        }

        .workspace-heading {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .workspace-heading h2 {
            font-size: 20px;
            letter-spacing: -0.01em;
        }

        .workspace {
            flex: 1;
            min-height: 0;
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-content: flex-start;
            padding: 20px;
            background: var(--surface-strong);
            border-radius: var(--radius-md);
            border: 2px dashed rgba(84, 101, 255, 0.18);
            position: relative;
            overflow: hidden;
            box-shadow: inset 0 1px 4px rgba(84, 101, 255, 0.08);
        }

        .workspace.dragover {
            background: rgba(84, 101, 255, 0.08);
            border-color: rgba(84, 101, 255, 0.38);
            box-shadow: inset 0 0 0 3px rgba(84, 101, 255, 0.18);
        }

        .canvas-term {
            position: relative;
            background: #eef0ff;
            padding: 10px 16px;
            border-radius: 18px;
            box-shadow: 0 12px 20px rgba(84, 101, 255, 0.18);
            cursor: grab;
            user-select: none;
            font-size: 16px;
            font-weight: 600;
            transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
            border: 1px solid rgba(84, 101, 255, 0.35);
            flex-shrink: 0;
            color: #363dcc;
        }

        .canvas-term:hover {
            transform: translateY(-2px);
            background: #dde1ff;
            box-shadow: 0 18px 28px rgba(84, 101, 255, 0.24);
        }

        .canvas-term:active {
            cursor: grabbing;
            transform: scale(0.98);
        }

        .canvas-term.dragging {
            opacity: 0.55;
        }

        .canvas-term .remove-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 20px;
            height: 20px;
            background: #ff5d72;
            border: 2px solid white;
            border-radius: 50%;
            color: white;
            font-size: 12px;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            line-height: 1;
            box-shadow: 0 10px 18px rgba(255, 93, 114, 0.3);
        }

        .canvas-term:hover .remove-btn {
            display: flex;
        }

        .insertion-marker {
            width: 3px;
            min-height: 50px;
            background: var(--primary);
            border-radius: 3px;
            flex-shrink: 0;
            opacity: 0.7;
        }

        .empty-state {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: var(--text-muted);
            font-size: 16px;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: center;
        }

        .empty-state-icon {
            font-size: 42px;
        }

        /* Sentences Panel */
        .sentences-panel {
            flex: 0 0 320px;
            background: var(--surface-muted);
            display: flex;
            flex-direction: column;
            gap: 16px;
            border-radius: var(--radius-md);
            padding: 18px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow-sm);
            transition: flex-basis 0.3s ease;
            height: 100%;
            min-height: 0;
            overflow: hidden;
        }

        .sentences-panel.focused {
            flex-basis: min(520px, 55%);
        }

        .sentences-header-box {
            display: flex;
            flex-direction: column;
            gap: 14px;
            flex-shrink: 0;
        }

        .sentences-header {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-strong);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .sentences-list {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding-right: 4px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-height: 0;
        }

        .sentence-item {
            padding: 12px 16px;
            background: var(--surface-strong);
            border-radius: var(--radius-sm);
            box-shadow: 0 10px 24px rgba(84, 101, 255, 0.14);
            font-size: 15px;
            line-height: 1.5;
            color: var(--text-strong);
            border: 1px solid rgba(84, 101, 255, 0.22);
            transition: transform 0.2s ease, box-shadow 0.2s ease, border 0.2s ease;
            cursor: pointer;
        }

        .sentence-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 18px 30px rgba(84, 101, 255, 0.22);
            border-color: rgba(84, 101, 255, 0.35);
        }

        .sentences-empty {
            text-align: center;
            color: var(--text-muted);
            font-size: 14px;
            padding: 24px 16px;
            background: rgba(84, 101, 255, 0.08);
            border-radius: var(--radius-sm);
            border: 1px dashed rgba(84, 101, 255, 0.25);
        }

        /* Loading */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(248, 250, 255, 0.78);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loading.show {
            display: flex;
        }

        .loading-card {
            background: var(--surface);
            border-radius: var(--radius-md);
            padding: 32px 40px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow-lg);
            text-align: center;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid rgba(84, 101, 255, 0.1);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 18px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: var(--text-strong);
            font-size: 16px;
            font-weight: 600;
        }

        @media (max-width: 1200px) {
            body {
                height: auto;
                min-height: 100vh;
                overflow-y: auto;
                padding: 12px;
            }

            .app-shell {
                height: auto;
            }

            .container {
                flex-direction: column;
                height: auto;
                padding: 16px;
            }

            .canvas-area {
                flex-direction: column;
                min-height: auto;
            }

            .sidebar,
            .sidebar.focused,
            .sentences-panel,
            .sentences-panel.focused {
                flex: 1 1 auto;
                width: 100%;
                height: auto;
            }

            .workspace-column {
                order: 2;
                height: auto;
            }

            .sentences-panel {
                order: 3;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 8px;
            }

            .container {
                padding: 16px;
            }

            .workspace {
                padding: 16px;
            }
        }
    </style>
</head>
<body>
    <!-- API Key Modal -->
    <div id="apiKeyModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(15, 23, 42, 0.7); display: flex; align-items: center; justify-content: center; z-index: 2000;">
        <div style="background: var(--surface); border-radius: var(--radius-md); padding: 32px; max-width: 500px; width: 90%; border: 1px solid var(--border); box-shadow: var(--shadow-lg);">
            <h2 style="margin-bottom: 16px; font-size: 24px;">Welcome! 🔑</h2>

            <!-- HTTPS Warning -->
            <div id="httpsWarning" style="display: none; background: #fff4e6; border: 1px solid #ff9800; border-radius: var(--radius-sm); padding: 12px; margin-bottom: 16px;">
                <div style="display: flex; gap: 8px; align-items: start;">
                    <span style="font-size: 18px;">⚠️</span>
                    <div style="font-size: 13px; color: #e65100;">
                        <strong>Security Warning:</strong> You're not using HTTPS. Your API key may be visible to attackers. Only use this on trusted networks.
                    </div>
                </div>
            </div>

            <p style="margin-bottom: 16px; color: var(--text-muted); line-height: 1.6; font-size: 14px;">
                To use this app, please enter your OpenAI API key.
            </p>

            <!-- Security notice -->
            <div style="background: #f0f4ff; border: 1px solid #5465ff; border-radius: var(--radius-sm); padding: 12px; margin-bottom: 16px;">
                <div style="font-size: 13px; color: var(--text-strong); line-height: 1.5;">
                    <strong>🔒 Security Notice:</strong><br>
                    • Your key is stored in your browser only<br>
                    • Never share your API key with others<br>
                    • Monitor your OpenAI usage regularly<br>
                    • This app sends requests through our server
                </div>
            </div>

            <input
                type="password"
                id="apiKeyInput"
                placeholder="sk-..."
                style="width: 100%; padding: 12px 16px; border-radius: var(--radius-sm); border: 1px solid var(--border); background: var(--surface-strong); font-size: 15px; margin-bottom: 12px;"
            />

            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px; font-size: 14px; cursor: pointer;">
                <input type="checkbox" id="sessionOnlyCheckbox" style="cursor: pointer;">
                <span>Session only (clear key when browser closes)</span>
            </label>

            <div style="display: flex; gap: 12px;">
                <button id="saveApiKeyBtn" class="btn btn-primary" style="flex: 1;">Save & Continue</button>
            </div>
            <p style="margin-top: 16px; font-size: 13px; color: var(--text-muted);">
                Don't have an API key? <a href="https://platform.openai.com/api-keys" target="_blank" style="color: var(--primary); text-decoration: underline;">Get one from OpenAI</a>
            </p>
        </div>
    </div>

    <div class="app-shell">
        <div class="container">
            <!-- Sidebar Word Bank -->
            <div class="sidebar" id="sidebar">
                <div class="sidebar-header">
                    <div class="logo">
                        <span>Word Bank</span>
                        <div style="display: flex; gap: 8px;">
                            <button class="focus-btn" id="changeApiKeyBtn" title="Change API Key" style="font-size: 14px;">🔑</button>
                            <button class="focus-btn" id="focusWordsBtn">⇄</button>
                        </div>
                    </div>
                    <div class="input-container">
                        <input
                            type="text"
                            id="contextInput"
                            placeholder="Enter context"
                        />
                        <button class="btn btn-primary" id="generateBtn">Generate Words</button>
                        <input type="file" id="imageInput" accept="image/*" style="display: none;">
                        <button class="btn btn-primary" id="attachImageBtn" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">📷 Attach Image</button>
                    </div>
                </div>

                <div class="search-box">
                    <input
                        type="text"
                        id="searchInput"
                        placeholder="Search words"
                    />
                </div>

                <div class="word-bank" id="wordBank"></div>

                <div class="term-count">
                    <span id="termCount">0 words in bank</span>
                </div>
            </div>

            <!-- Canvas Area -->
            <div class="canvas-area">
                <div class="workspace-column">
                    <div class="workspace-heading">
                        <h2>Workspace</h2>
                    </div>

                    <div class="workspace" id="workspace">
                        <div class="empty-state">
                            <div class="empty-state-icon">💬</div>
                            <div>Workspace empty</div>
                        </div>
                    </div>
                </div>

                <!-- Sentences Panel -->
                <div class="sentences-panel" id="sentencesPanel">
                    <div class="sentences-header-box">
                        <div class="sentences-header">
                            <span>Sentences</span>
                            <button class="focus-btn" id="focusSentencesBtn">⇄</button>
                        </div>
                        <button class="btn btn-primary" id="generateSentencesBtn">Create Sentences</button>
                    </div>
                    <div class="sentences-list" id="sentencesList">
                        <div class="sentences-empty">No sentences yet.</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="loading" id="loading">
        <div class="loading-card">
            <div class="spinner"></div>
            <div class="loading-text">Generating words...</div>
        </div>
    </div>

    <script>
        const normalizeBasePath = (path) => {
            if (!path || path === '/') {
                return '';
            }
            return path.endsWith('/') ? path.slice(0, -1) : path;
        };

        const BASE_PATH = normalizeBasePath(window.APP_CONFIG?.basePath);
        const buildUrl = (endpoint) => `${BASE_PATH}${endpoint}`;

        // API Key Management
        let apiKey = localStorage.getItem('openai_api_key') || sessionStorage.getItem('openai_api_key') || '';
        const apiKeyModal = document.getElementById('apiKeyModal');
        const apiKeyInput = document.getElementById('apiKeyInput');
        const saveApiKeyBtn = document.getElementById('saveApiKeyBtn');
        const changeApiKeyBtn = document.getElementById('changeApiKeyBtn');
        const sessionOnlyCheckbox = document.getElementById('sessionOnlyCheckbox');
        const httpsWarning = document.getElementById('httpsWarning');

        // Check if using HTTPS
        if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost') {
            httpsWarning.style.display = 'block';
        }

        // Check if API key exists on load
        if (apiKey) {
            apiKeyModal.style.display = 'none';
        }

        // Check if user previously selected session-only mode
        const useSessionOnly = localStorage.getItem('use_session_only') === 'true';
        if (useSessionOnly) {
            sessionOnlyCheckbox.checked = true;
        }

        saveApiKeyBtn.addEventListener('click', () => {
            const key = apiKeyInput.value.trim();
            if (!key) {
                alert('Please enter a valid API key');
                return;
            }
            if (!key.startsWith('sk-')) {
                alert('Invalid API key format. OpenAI keys start with "sk-"');
                return;
            }
            apiKey = key;

            // Store based on user preference
            if (sessionOnlyCheckbox.checked) {
                sessionStorage.setItem('openai_api_key', key);
                localStorage.setItem('use_session_only', 'true');
                localStorage.removeItem('openai_api_key');
            } else {
                localStorage.setItem('openai_api_key', key);
                localStorage.setItem('use_session_only', 'false');
                sessionStorage.removeItem('openai_api_key');
            }

            apiKeyModal.style.display = 'none';
            apiKeyInput.value = '';
        });

        changeApiKeyBtn.addEventListener('click', () => {
            apiKeyModal.style.display = 'flex';
            apiKeyInput.value = '';
            apiKeyInput.focus();
        });

        apiKeyInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                saveApiKeyBtn.click();
            }
        });

        // Main app logic
        let allTerms = [];
        let canvasTerms = [];

        // Category data with emojis and words
        const categories = {
            '🤖 Context': { emoji: '🤖', name: 'Context', words: [] },
            '👤 Pronouns': { emoji: '👤', name: 'Pronouns', words: ['👤 I', '👥 you', '👨 he', '👩 she', '⚡ it', '👫 we', '👥 they', '🙋 me', '🙋‍♂️ him', '🙋‍♀️ her', '🤝 us', '👬 them', '📌 my', '📍 your', '🔹 his', '🔸 her', '⭐ its', '🌟 our', '✨ their', '👉 this', '👈 that', '🔽 these', '🔼 those', '❓ who', '❔ what', '🔀 which', '🏷️ whose'] },
            '❓ Question Words': { emoji: '❓', name: 'Question Words', words: ['❓ who', '❔ what', '⏰ when', '📍 where', '🤔 why', '🛠️ how', '🔀 which', '🏷️ whose', '💰 how much', '🔢 how many', '⏱️ how long', '📏 how far', '🔁 how often'] },
            '📍 Prepositions': { emoji: '📍', name: 'Prepositions', words: ['📥 in', '🔛 on', '📍 at', '👉 by', '🤝 with', '⬅️ from', '➡️ to', '📦 of', '🎁 for', '💭 about', '⬆️ above', '▶️ after', '🚫 against', '🛤️ along', '🎪 among', '🔄 around', '⏪ before', '⬇️ behind', '🔽 below', '⬌ between', '🌌 beyond', '⬇️ down', '⏳ during', '🚷 except', '🏠 inside', '📥 into', '💝 like', '📌 near', '🔌 off', '🚪 out', '🏞️ outside', '🔝 over', '⏮️ past', '📅 since', '🔀 through', '🎯 toward', '⬇️ under', '⏳ until', '⬆️ up', '📦 within', '🚫 without'] },
            '🙏 Politeness': { emoji: '🙏', name: 'Politeness', words: ['🙏 please', '💝 thank you', '🙌 thanks', '😔 sorry', '🙋 excuse me', '🤗 welcome'] },
            '👋 Greetings': { emoji: '👋', name: 'Greetings', words: ['👋 hello', '✋ hi', '🙌 hey', '🌅 good morning', '☀️ good afternoon', '🌆 good evening', '🌙 good night', '👋 goodbye', '✌️ bye', '👀 see you', '💝 take care', '🤝 nice to meet you', '❓ how are you'] },
            '🗺️ Location': { emoji: '🗺️', name: 'Location', words: ['📍 here', '👉 there', '🌍 everywhere', '❓ somewhere', '🗺️ anywhere', '🚫 nowhere', '⬆️ up', '⬇️ down', '⬅️ left', '➡️ right', '▶️ forward', '◀️ backward', '🔜 ahead', '🔙 behind', '📌 nearby', '🌌 far', '🤏 close', '↗️ away', '🔄 around', '🏠 inside', '🌳 outside', '⬆️ upstairs', '⬇️ downstairs', '↔️ next to'] },
            '⏰ Time': { emoji: '⏰', name: 'Time', words: ['⚡ now', '⏰ then', '📅 today', '⏮️ yesterday', '⏭️ tomorrow', '🌙 tonight', '🌅 morning', '☀️ afternoon', '🌆 evening', '🌃 night', '⏰ later', '🔜 soon', '⏰ early', '⌛ late', '⏪ before', '⏩ after', '⏳ during', '⌚ while', '♾️ always', '🚫 never', '🔄 sometimes', '📊 often', '🥉 rarely', '📈 usually', '✅ already', '⏰ yet', '⏸️ still', '⚡ just'] },
            '👁️ Senses': { emoji: '👁️', name: 'Senses', words: ['👁️ see', '👀 look', '📺 watch', '👂 hear', '🎧 listen', '👃 smell', '👅 taste', '🤚 touch', '💭 feel'] },
            '🧠 Thinking & Feeling': { emoji: '🧠', name: 'Thinking & Feeling', words: ['🧠 know', '💭 think', '✨ believe', '💡 understand', '🧠 remember', '🌫️ forget', '📚 learn', '🌈 imagine', '💝 want', '📍 need', '❤️ like', '💖 love', '💔 hate', '💝 care', '⚡ do', '🔨 make', '📦 get', '🤲 take', '🎁 give', '📌 put', '🔧 use', '🔍 find', '👉 show', '🤝 help', '✅ let', '📦 keep', '👋 leave', '▶️ start', '⏹️ stop', '🏁 end', '▶️ continue', '💪 try', '❌ fail', '💼 work', '🎮 play', '😴 rest', '⏰ wait', '📍 stay', '🔄 become', '🔀 change', '🌱 grow', '➕ add', '➖ remove', '📉 lose', '🏆 win', '🛒 buy', '💵 sell', '💸 spend', '💰 save', '🤝 share'] },
            '🚶 Doing & Talking': { emoji: '🚶', name: 'Doing & Talking', words: ['🚶 go', '👋 come', '🏃 move', '🚶 walk', '🏃 run', '🦘 jump', '🧗 climb', '⬇️ fall', '🪑 sit', '🧍 stand', '😴 sleep', '⏰ wake', '🔄 turn', '👉 push', '🤲 pull', '⬆️ lift', '📦 carry', '🤲 hold', '✊ grab', '🤾 catch', '🎯 throw', '👊 hit', '🦵 kick', '🤚 touch', '🤲 reach', '👉 point', '👋 wave', '🚪 open', '🔒 close', '💥 break', '🔧 fix', '🏗️ build', '✨ clean', '🚿 wash', '💨 dry', '👕 wear', '➖ remove', '⬇️ drop', '💬 say', '🗣️ tell', '💬 talk', '❓ ask', '💡 answer', '↩️ reply', '📖 explain', '📝 describe', '📞 call', '📣 shout', '🤫 whisper', '😱 yell', '😂 laugh', '😊 smile', '🍽️ eat', '🥤 drink'] },
            '🔢 Quantity': { emoji: '🔢', name: 'Quantity', words: ['💯 all', '📊 some', '📈 many', '🤏 few', '💯 much', '🤏 little', '➕ more', '➖ less', '🏆 most', '🥉 least', '✅ enough', '🚫 none', '❓ any', '1️⃣ each', '💯 every', '2️⃣ both', '🔀 either', '🚫 neither', '½ half', '💯 whole', '🧩 part', '🧩 piece'] },
            '✨ Describing Words': { emoji: '✨', name: 'Describing Words', words: ['👍 good', '👎 bad', '📏 big', '🤏 small', '📏 long', '📐 short', '🗼 tall', '⬆️ high', '⬇️ low', '↔️ wide', '🚪 narrow', '📚 thick', '📄 thin', '⚖️ heavy', '🪶 light', '🪨 hard', '🧸 soft', '🔥 hot', '❄️ cold', '☀️ warm', '🧊 cool', '✨ new', '📜 old', '👶 young', '⚡ fast', '🐌 slow', '✅ easy', '😰 difficult', '✨ clean', '🗑️ dirty', '😊 nice', '💪 strong', '😔 weak', '💡 bright', '🌑 dark', '📢 loud', '🤫 quiet', '📦 full', '📭 empty', '✅ safe', '⚠️ dangerous'] },
            '🔗 Connectors': { emoji: '🔗', name: 'Connectors', words: ['➕ and', '🔀 or', '❗ but', '↗️ so', '💡 because', '❓ if', '➡️ then', '⏰ while', '🚫 unless', '⏳ until', '📅 since'] },
            '✅ Yes & No': { emoji: '✅', name: 'Yes & No', words: ['✅ yes', '❌ no', '👌 okay', '👍 sure', '😊 fine', '✅ right', '🤔 maybe', '✅ I agree', '❌ I disagree', '🤔 I think so', "🤷 I don't think so"] },
            '📦 Common Nouns': { emoji: '📦', name: 'Common Nouns', words: ['👤 person', '👥 people', '👨 man', '👩 woman', '👶 child', '👨‍👩‍👧‍👦 family', '🤝 friend', '📦 thing', '📍 place', '⏰ time', '📅 day', '📆 year', '🛤️ way', '💼 work', '🏠 home', '🏡 house', '🚪 room', '🚪 door', '🪟 window', '🪑 table', '🪑 chair', '🛏️ bed', '🍽️ food', '💧 water', '💰 money', '📚 book', '📱 phone', '🚗 car', '🏙️ city', '🌍 country', '🌎 world', '💫 life', '✋ hand', '👁️ eye', '😊 face', '🧠 head', '🫀 body', '🧩 part', '↔️ side', '⬅️ back', '⬆️ top', '⬇️ bottom', '🏁 end', '📍 point', '💬 word', '🏷️ name', '🔢 number', '❓ question', '⚠️ problem', '💡 idea', '📖 story'] }
        };

        const contextInput = document.getElementById('contextInput');
        const generateBtn = document.getElementById('generateBtn');
        const wordBank = document.getElementById('wordBank');
        const workspace = document.getElementById('workspace');
        const loading = document.getElementById('loading');
        const searchInput = document.getElementById('searchInput');
        const termCount = document.getElementById('termCount');
        const imageInput = document.getElementById('imageInput');
        const attachImageBtn = document.getElementById('attachImageBtn');

        // Initialize with default categories
        displayWordBank();

        generateBtn.addEventListener('click', generateTerms);
        contextInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') generateTerms();
        });

        // Image upload handling
        attachImageBtn.addEventListener('click', () => {
            imageInput.click();
        });

        imageInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            if (!apiKey) {
                alert('Please enter your API key first');
                apiKeyModal.style.display = 'flex';
                imageInput.value = '';
                return;
            }

            loading.classList.add('show');
            document.querySelector('.loading-text').textContent = 'Analyzing image...';
            attachImageBtn.disabled = true;

            try {
                const formData = new FormData();
                formData.append('image', file);
                formData.append('api_key', apiKey);

                const response = await fetch(buildUrl('/analyze-image'), {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    // Set the description as context and auto-generate
                    contextInput.value = data.description;
                    await generateTerms();
                } else {
                    alert('Error analyzing image: ' + data.error);
                }
            } catch (error) {
                alert('Error analyzing image: ' + error.message);
            } finally {
                loading.classList.remove('show');
                document.querySelector('.loading-text').textContent = 'Generating words...';
                attachImageBtn.disabled = false;
                imageInput.value = ''; // Reset file input
            }
        });

        async function generateTerms() {
            const context = contextInput.value.trim();
            if (!context) {
                alert('Please enter a context');
                return;
            }

            if (!apiKey) {
                alert('Please enter your API key first');
                apiKeyModal.style.display = 'flex';
                return;
            }

            loading.classList.add('show');
            generateBtn.disabled = true;

            try {
                const response = await fetch(buildUrl('/generate'), {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ context, api_key: apiKey })
                });

                const data = await response.json();

                if (data.success) {
                    // Put generated terms in the Context category
                    categories['🤖 Context'].words = data.terms;
                    allTerms = getAllTerms();
                    displayWordBank();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error generating terms: ' + error.message);
            } finally {
                loading.classList.remove('show');
                generateBtn.disabled = false;
            }
        }

        function getAllTerms() {
            let terms = [];
            for (let categoryKey in categories) {
                terms = terms.concat(categories[categoryKey].words);
            }
            return terms;
        }

        function displayWordBank(searchQuery = '') {
            wordBank.innerHTML = '';

            for (let categoryKey in categories) {
                const categoryData = categories[categoryKey];
                const categoryTerms = categoryData.words;

                // Filter by search if applicable
                let filteredTerms = categoryTerms;
                if (searchQuery) {
                    filteredTerms = categoryTerms.filter(term =>
                        term.toLowerCase().includes(searchQuery.toLowerCase())
                    );
                }

                // Skip empty categories when searching
                if (searchQuery && filteredTerms.length === 0) continue;

                // Create category
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'category';

                // Category header
                const header = document.createElement('div');
                header.className = 'category-header';
                header.innerHTML = `
                    <span class="category-icon">${categoryData.emoji}</span>
                    <span class="category-name">${categoryData.name} (${filteredTerms.length})</span>
                    <span class="category-arrow">▶</span>
                `;

                // Category content
                const content = document.createElement('div');
                content.className = 'category-content';

                // Add terms
                filteredTerms.forEach(term => {
                    const card = document.createElement('div');
                    card.className = 'bank-term';
                    card.textContent = term;
                    card.draggable = true;

                    card.addEventListener('dragstart', (e) => {
                        e.dataTransfer.setData('text/plain', term);
                        e.dataTransfer.effectAllowed = 'copy';
                    });

                    card.addEventListener('click', () => {
                        addToCanvas(term);
                    });

                    content.appendChild(card);
                });

                // Toggle expand/collapse
                header.addEventListener('click', () => {
                    const arrow = header.querySelector('.category-arrow');
                    const isExpanded = content.classList.contains('expanded');

                    if (isExpanded) {
                        content.classList.remove('expanded');
                        arrow.classList.remove('expanded');
                        header.classList.remove('expanded');
                    } else {
                        content.classList.add('expanded');
                        arrow.classList.add('expanded');
                        header.classList.add('expanded');
                    }
                });

                categoryDiv.appendChild(header);
                categoryDiv.appendChild(content);
                wordBank.appendChild(categoryDiv);
            }

            updateTermCount();
        }

        searchInput.addEventListener('input', (e) => {
            const query = e.target.value;
            displayWordBank(query);
        });

        // Canvas drag and drop
        let draggedCard = null;
        let insertionMarker = null;

        workspace.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.dataTransfer.dropEffect = draggedCard ? 'move' : 'copy';
            workspace.classList.add('dragover');

            const afterElement = getDragAfterElement(workspace, e.clientX, e.clientY);

            // Remove existing marker
            if (insertionMarker && !draggedCard) {
                insertionMarker.remove();
                insertionMarker = null;
            }

            if (draggedCard) {
                // Reordering existing card
                if (afterElement == null) {
                    workspace.appendChild(draggedCard);
                } else {
                    workspace.insertBefore(draggedCard, afterElement);
                }
            } else {
                // Show insertion marker for new items
                if (!insertionMarker) {
                    insertionMarker = document.createElement('div');
                    insertionMarker.className = 'insertion-marker';
                }

                if (afterElement == null) {
                    workspace.appendChild(insertionMarker);
                } else {
                    workspace.insertBefore(insertionMarker, afterElement);
                }
            }
        });

        workspace.addEventListener('dragleave', (e) => {
            if (e.target === workspace) {
                workspace.classList.remove('dragover');
                if (insertionMarker) {
                    insertionMarker.remove();
                    insertionMarker = null;
                }
            }
        });

        workspace.addEventListener('drop', (e) => {
            e.preventDefault();
            workspace.classList.remove('dragover');

            // Clean up insertion marker
            if (insertionMarker) {
                insertionMarker.remove();
                insertionMarker = null;
            }

            const term = e.dataTransfer.getData('text/plain');
            if (term && !draggedCard) {
                // Adding from sidebar
                const afterElement = getDragAfterElement(workspace, e.clientX, e.clientY);
                addToCanvas(term, afterElement);
            }

            draggedCard = null;
        });

        function getDragAfterElement(container, x, y) {
            const draggableElements = [...container.querySelectorAll('.canvas-term:not(.dragging)')];

            let closestElement = null;
            let closestDistance = Infinity;

            draggableElements.forEach(child => {
                const box = child.getBoundingClientRect();
                const centerX = box.left + box.width / 2;
                const centerY = box.top + box.height / 2;

                const distance = Math.sqrt(Math.pow(x - centerX, 2) + Math.pow(y - centerY, 2));

                // If cursor is to the left of the element's center, insert before it
                if (x < centerX && distance < closestDistance) {
                    closestDistance = distance;
                    closestElement = child;
                }
            });

            return closestElement;
        }

        function addToCanvas(term, beforeElement) {
            const card = document.createElement('div');
            card.className = 'canvas-term';
            card.textContent = term;
            card.draggable = true;

            // Remove button
            const removeBtn = document.createElement('div');
            removeBtn.className = 'remove-btn';
            removeBtn.textContent = '×';
            removeBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                card.remove();
                canvasTerms = canvasTerms.filter(t => t.element !== card);

                // Show empty state if no more terms
                const emptyState = workspace.querySelector('.empty-state');
                if (emptyState && canvasTerms.length === 0) {
                    emptyState.style.display = 'block';
                }
            });
            card.appendChild(removeBtn);

            // Drag events for reordering
            card.addEventListener('dragstart', (e) => {
                draggedCard = card;
                card.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
            });

            card.addEventListener('dragend', () => {
                card.classList.remove('dragging');
                draggedCard = null;
            });

            // Insert at position or append
            if (beforeElement) {
                workspace.insertBefore(card, beforeElement);
            } else {
                workspace.appendChild(card);
            }

            canvasTerms.push({ term, element: card });

            // Hide empty state
            const emptyState = workspace.querySelector('.empty-state');
            if (emptyState && canvasTerms.length > 0) {
                emptyState.style.display = 'none';
            }
        }

        function updateTermCount() {
            const total = getAllTerms().length;
            termCount.textContent = `${total} words in bank`;
        }

        // Sentence generation
        const generateSentencesBtn = document.getElementById('generateSentencesBtn');
        const sentencesList = document.getElementById('sentencesList');

        generateSentencesBtn.addEventListener('click', async () => {
            // Get words from workspace in order
            const wordsInWorkspace = Array.from(workspace.querySelectorAll('.canvas-term'))
                .map(el => el.textContent.replace('×', '').trim());

            if (wordsInWorkspace.length === 0) {
                alert('Add some words to the workspace first!');
                return;
            }

            if (!apiKey) {
                alert('Please enter your API key first');
                apiKeyModal.style.display = 'flex';
                return;
            }

            generateSentencesBtn.disabled = true;
            generateSentencesBtn.textContent = 'Generating...';
            sentencesList.innerHTML = '<div class="sentences-empty">Generating sentences...</div>';

            try {
                const response = await fetch(buildUrl('/generate-sentences'), {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ words: wordsInWorkspace, api_key: apiKey })
                });

                const data = await response.json();

                if (data.success && data.sentences) {
                    sentencesList.innerHTML = '';
                    data.sentences.forEach(sentence => {
                        const sentenceItem = document.createElement('div');
                        sentenceItem.className = 'sentence-item';
                        sentenceItem.textContent = sentence;
                        sentencesList.appendChild(sentenceItem);
                    });
                } else {
                    sentencesList.innerHTML = '<div class="sentences-empty">Error generating sentences. Please try again.</div>';
                }
            } catch (error) {
                console.error('Error:', error);
                sentencesList.innerHTML = '<div class="sentences-empty">Error generating sentences. Please try again.</div>';
            } finally {
                generateSentencesBtn.disabled = false;
                generateSentencesBtn.textContent = 'Create Sentences';
            }
        });

        // Focus functionality
        const sidebar = document.getElementById('sidebar');
        const sentencesPanel = document.getElementById('sentencesPanel');
        const focusWordsBtn = document.getElementById('focusWordsBtn');
        const focusSentencesBtn = document.getElementById('focusSentencesBtn');

        focusWordsBtn.addEventListener('click', () => {
            const isFocused = sidebar.classList.contains('focused');

            if (isFocused) {
                sidebar.classList.remove('focused');
                focusWordsBtn.classList.remove('active');
                focusWordsBtn.textContent = '⇄';
            } else {
                sidebar.classList.add('focused');
                sentencesPanel.classList.remove('focused');
                focusWordsBtn.classList.add('active');
                focusSentencesBtn.classList.remove('active');
                focusWordsBtn.textContent = '⇆';
                focusSentencesBtn.textContent = '⇄';
            }
        });

        focusSentencesBtn.addEventListener('click', () => {
            const isFocused = sentencesPanel.classList.contains('focused');

            if (isFocused) {
                sentencesPanel.classList.remove('focused');
                focusSentencesBtn.classList.remove('active');
                focusSentencesBtn.textContent = '⇄';
            } else {
                sentencesPanel.classList.add('focused');
                sidebar.classList.remove('focused');
                focusSentencesBtn.classList.add('active');
                focusWordsBtn.classList.remove('active');
                focusSentencesBtn.textContent = '⇆';
                focusWordsBtn.textContent = '⇄';
            }
        });
    </script>
</body>
</html>
